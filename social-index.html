<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>MDM Social Review</title>
<link rel="stylesheet" href="social-style.css">
<style>
body { padding-top: 92px; }
.filters { max-width:920px; margin:0 auto; padding:0 40px 0; display:flex; align-items:center; gap:10px; flex-wrap:wrap; border-top:1px solid var(--border); padding-top:13px; padding-bottom:13px; }
.filter-label { font-size:11px; font-weight:600; letter-spacing:.45em; color:var(--muted); text-transform:uppercase; margin-right:2px; }
.filter-btn { font-family:'Montserrat',sans-serif; font-size:11px; font-weight:600; letter-spacing:.35em; text-transform:uppercase; padding:6px 14px; border:1px solid var(--border); background:transparent; color:var(--muted); cursor:pointer; transition:all .18s; }
.filter-btn:hover { border-color:var(--gold); color:var(--gold); }
.filter-btn.active { background:var(--gold); color:var(--darker); border-color:var(--gold); }
.filter-sep { width:1px; height:20px; background:var(--border); margin:0 4px; }
</style>
</head>
<body>

<!-- NAV -->
<nav class="site-nav">
  <a href="social-index.html" class="nav-brand">
    <div class="nav-monogram">MDM</div>
    <span class="nav-title">Social Review</span>
  </a>
  <div class="nav-right">
    <span class="live-dot" id="live-indicator">Connecting‚Ä¶</span>
    <div class="nav-progress">
      <span class="nav-pill approved" id="pill-approved">0 ‚úì</span>
      <span class="nav-pill needs"    id="pill-needs">0 ‚ö†</span>
      <span class="nav-pill rejected" id="pill-rejected">0 ‚úï</span>
    </div>
  </div>
</nav>

<!-- PORTAL SWITCHER -->
<div class="portal-switcher">
  <a href="index.html" class="portal-switch-link">
    <span>üìù</span> Blog Review
  </a>
  <a href="social-index.html" class="portal-switch-link active">
    <span>üì≤</span> Social Review
  </a>
</div>

<!-- HERO -->
<div class="hero">
  <p class="hero-eyebrow">MDM Design Studio ¬∑ 2026</p>
  <h1 class="hero-title"><strong>Social Media</strong> Review Portal</h1>
  <p class="hero-sub">Review and approve upcoming Instagram &amp; Facebook posts ‚Äî changes sync live across all devices.</p>
</div>
<div class="gold-rule"></div>

<!-- STATS -->
<div class="stats-wrap">
  <div class="stats-row">
    <div class="stat-block s-total">   <span class="stat-n" id="stat-total">2</span><span class="stat-l">Total</span></div>
    <div class="stat-block s-approved"><span class="stat-n" id="count-approved">0</span><span class="stat-l">Approved</span></div>
    <div class="stat-block s-needs">   <span class="stat-n" id="count-needs">0</span><span class="stat-l">Changes</span></div>
    <div class="stat-block s-rejected"><span class="stat-n" id="count-rejected">0</span><span class="stat-l">Rejected</span></div>
    <div class="stat-block s-pending"> <span class="stat-n" id="count-pending">2</span><span class="stat-l">Pending</span></div>
  </div>
</div>

<!-- PROGRESS -->
<div class="progress-wrap">
  <div class="progress-meta">
    <span>Review Progress</span>
    <span id="progress-pct">0%</span>
  </div>
  <div class="progress-track"><div class="progress-fill" id="progress-bar-fill"></div></div>
</div>

<!-- FILTERS -->
<div class="filters">
  <span class="filter-label">Status</span>
  <button class="filter-btn active" onclick="setFilter('all',this)">All</button>
  <button class="filter-btn" onclick="setFilter('pending',this)">Pending</button>
  <button class="filter-btn" onclick="setFilter('approved',this)">Approved</button>
  <button class="filter-btn" onclick="setFilter('needs',this)">Changes</button>
  <button class="filter-btn" onclick="setFilter('rejected',this)">Rejected</button>
</div>

<!-- POST LIST -->
<p class="section-label">Scheduled Posts</p>
<div class="post-list" id="post-list"></div>

<!-- FOOTER -->
<div class="portal-footer">
  <span class="footer-brand">MDM Design Studio ¬∑ Social Review 2026</span>
  <div style="display:flex;gap:10px;flex-wrap:wrap;">
    <button class="footer-btn" onclick="exportSummary()">‚Üì Export Summary</button>
    <a href="index.html" class="footer-btn">Blog Portal ‚Üí</a>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script src="social-app.js"></script>
<script src="social-posts-data.js"></script>
<script>
let _currentFilter = 'all';

// _liveCaptions holds the latest saved caption per post id, fetched from Firebase
// Falls back to static data caption if nothing saved yet
const _liveCaptions = {};

function buildRows() {
  const list = document.getElementById('post-list');
  list.innerHTML = '';
  SOCIAL_POSTS.forEach(p => {
    const d          = _localCache[p.id] || { status:'pending' };
    // Use Firebase-saved caption if available, otherwise fall back to static data
    const rawCap     = _liveCaptions[p.id] || p.caption || '';
    const capPreview = rawCap.slice(0, 90) + (rawCap.length > 90 ? '‚Ä¶' : '');
    const row        = document.createElement('a');
    row.className    = 'post-row';
    row.id           = 'row-'+p.id;
    row.href         = 'social-post-0'+p.id+'.html';
    row.dataset.status = d.status||'pending';
    const badgeLabel = {pending:'Pending',approved:'Approved',needs:'Changes',rejected:'Rejected'}[d.status||'pending'];
    row.innerHTML = `
      <div class="col-thumb"><img src="${p.photo}" alt="" onerror="this.parentNode.innerHTML='<div style=width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:22px>${p.mediaEmoji}</div>'"></div>
      <div class="col-num">0${p.id}</div>
      <div class="col-date">
        <span class="weekday">${p.dayOfWeek}</span>
        <span class="date">${p.postDate}</span>
      </div>
      <div class="col-caption">
        <span class="cap-text" id="cap-preview-${p.id}">${capPreview}</span>
        <span class="cap-meta">Instagram + Facebook ¬∑ ${p.postTime}</span>
      </div>
      <div class="col-status">
        <span class="dash-comment" title="${d.comment||''}">${d.comment?'üí¨':''}</span>
        <span class="dash-status status-badge ${d.status||'pending'}"><span class="badge-text">${badgeLabel}</span></span>
      </div>
      <div class="col-arrow">‚Ä∫</div>`;
    list.appendChild(row);
  });
}

// Update just the caption preview text for one post ‚Äî no full rebuild needed
function updateCapPreview(postId, caption) {
  const el = document.getElementById('cap-preview-' + postId);
  if (!el) return;
  const trimmed = (caption || '').slice(0, 90) + ((caption||'').length > 90 ? '‚Ä¶' : '');
  el.textContent = trimmed;
}

// Subscribe to Firebase -content/{postId} for each post so caption previews
// update live whenever anyone saves a new version on a post page
function watchLiveCaptions() {
  if (!IS_CONFIGURED || typeof firebase === 'undefined' || !firebase.apps.length) return;
  SOCIAL_POSTS.forEach(p => {
    firebase.database()
      .ref(CONFIG.dbPath + '-content/' + p.id)
      .on('value', snap => {
        const data = snap.val();
        if (data && data.caption) {
          _liveCaptions[p.id] = data.caption;
          updateCapPreview(p.id, data.caption);
        }
      });
  });
}

function setFilter(f, btn) {
  _currentFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.post-row').forEach(row => {
    row.style.display = (f==='all' || row.dataset.status===f) ? '' : 'none';
  });
}

// Override renderDashboard to rebuild rows (preserving live captions)
window.renderDashboard = function() {
  buildRows();
  document.querySelectorAll('.post-row').forEach(row => {
    row.style.display = (_currentFilter==='all' || row.dataset.status===_currentFilter) ? '' : 'none';
  });
  // Re-apply any live captions that arrived before this rebuild
  Object.entries(_liveCaptions).forEach(([id, cap]) => updateCapPreview(Number(id), cap));
  updateCounts();
  updateNavPills();
};

emailjs.init(CONFIG.emailjsPublicKey);
initFirebase();
buildRows();

// After Firebase is ready: watch live captions + connection status
setTimeout(() => {
  if (typeof firebase !== 'undefined' && firebase.apps.length) {
    // Connection indicator
    firebase.database().ref('.info/connected').on('value', snap => {
      const el = document.getElementById('live-indicator');
      if (!el) return;
      if (snap.val()) { el.textContent='Live'; el.className='live-dot connected'; }
      else { el.textContent='Offline'; el.className='live-dot offline'; }
    });
    // Live caption sync
    watchLiveCaptions();
  }
}, 400);
</script>
</body>
</html>
