<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Our Most Common Client Regrets — MDM Design Studio</title>
<link rel="stylesheet" href="style.css">
<style>
body { padding-top: 56px; padding-bottom: env(safe-area-inset-bottom, 120px); }
.post-header { background: var(--dark); padding: 48px 0 40px; border-bottom: 1px solid var(--border); position: relative; overflow: hidden; }
.post-header::before { content:''; position:absolute; inset:0; background-image: linear-gradient(var(--border2) 1px,transparent 1px),linear-gradient(90deg,var(--border2) 1px,transparent 1px); background-size:48px 48px; opacity:.3; pointer-events:none; }
.phi { position:relative; z-index:1; max-width:740px; margin:0 auto; padding:0 40px; }
.post-meta-row { display:flex; align-items:center; gap:14px; margin-bottom:20px; flex-wrap:wrap; }
.post-num-badge { font-size:16px; font-weight:600; letter-spacing:.3em; color:var(--gold); text-transform:uppercase; border:1px solid var(--border); padding:5px 12px; background:var(--darker); }
.post-date-str { font-size:16px; font-weight:400; letter-spacing:.15em; color:var(--muted); text-transform:uppercase; }
.post-cat { font-size:16px; font-weight:500; letter-spacing:.3em; color:var(--gold); text-transform:uppercase; }
.post-title { font-family:'Montserrat',sans-serif; font-weight:600; font-size:32px; line-height:1.2; letter-spacing:.01em; color:var(--text); margin-bottom:10px; }
.post-subtitle { font-family:'Montserrat',sans-serif; font-style:italic; font-weight:300; font-size:20px; color:var(--gold); margin-bottom:24px; line-height:1.4; }
.seo-box { background:var(--panel); border:1px solid var(--border); border-left:2px solid var(--gold); padding:13px 18px; margin-top:22px; }
.seo-box .seo-lbl { font-size:16px; font-weight:600; letter-spacing:.3em; color:var(--gold); text-transform:uppercase; margin-bottom:5px; display:block; }
.seo-box p { font-size:16px; font-weight:300; color:var(--text2); line-height:1.6; }
.pbw { max-width:740px; margin:0 auto; padding:48px 40px 0; }
.post-body h2 { font-family:'Montserrat',sans-serif; font-weight:600; font-size:22px; letter-spacing:.01em; color:var(--text); margin:36px 0 14px; line-height:1.3; }
.post-body h3 { font-family:'Montserrat',sans-serif; font-weight:500; font-size:18px; letter-spacing:.08em; color:var(--gold); text-transform:uppercase; margin:24px 0 10px; }
.post-body p { font-size:17px; font-weight:300; line-height:1.9; color:var(--text2); margin-bottom:18px; letter-spacing:.01em; }
.post-body em { font-style:italic; color:var(--text); }
.post-body strong { font-weight:600; color:var(--text); }
.post-body a { color:var(--gold); text-decoration:none; border-bottom:1px solid transparent; transition:border-color .2s; }
.post-body a:hover { border-bottom-color:var(--gold); }
.post-body p.cta-text { margin-top:36px; padding:22px 26px; background:var(--panel); border:1px solid var(--border); border-left:2px solid var(--gold); font-size:17px; font-style:italic; color:var(--text2); }

/* ── DISCUSSION SECTION ── */
.discussion-outer { max-width:740px; margin:0 auto; padding:48px 40px 0; }
.discussion-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:16px; }
.discussion-title { font-size:16px; font-weight:600; letter-spacing:.35em; color:var(--gold); text-transform:uppercase; }
.discussion-subtitle { font-size:16px; color:var(--muted); font-weight:300; margin-top:4px; }
.comment-form { background:var(--panel); border:1px solid var(--border); padding:20px; margin-bottom:28px; }
.comment-form-row { display:flex; gap:10px; margin-bottom:12px; }
.comment-name-input { flex:1; font-family:'Montserrat',sans-serif; font-size:16px; font-weight:400; background:var(--darker); border:1px solid var(--border); color:var(--text); padding:11px 14px; outline:none; transition:border-color .2s; }
.comment-name-input:focus { border-color:var(--gold); }
.comment-textarea { width:100%; box-sizing:border-box; font-family:'Montserrat',sans-serif; font-size:16px; font-weight:300; background:var(--darker); border:1px solid var(--border); color:var(--text); padding:12px 14px; resize:vertical; min-height:90px; outline:none; transition:border-color .2s; }
.comment-textarea:focus { border-color:var(--gold); }
.comment-submit { font-family:'Montserrat',sans-serif; font-size:16px; font-weight:600; letter-spacing:.25em; text-transform:uppercase; padding:11px 24px; background:var(--gold); color:var(--darker); border:none; cursor:pointer; transition:opacity .18s; margin-top:8px; }
.comment-submit:hover { opacity:.85; }
.comments-list { display:flex; flex-direction:column; gap:16px; margin-bottom:60px; }
.comment-item { background:var(--panel); border:1px solid var(--border); padding:18px 20px; }
.comment-item.highlight { border-left:2px solid var(--gold); }
.comment-meta { display:flex; align-items:center; gap:12px; margin-bottom:10px; }
.comment-author { font-size:16px; font-weight:600; color:var(--text); letter-spacing:.05em; }
.comment-time { font-size:16px; color:var(--muted); font-weight:300; }
.comment-status-tag { font-size:16px; font-weight:600; letter-spacing:.2em; text-transform:uppercase; padding:3px 9px; border-radius:2px; }
.comment-status-tag.approved { background:var(--approved-bg); color:var(--approved-txt); border:1px solid var(--approved-bd); }
.comment-status-tag.needs { background:var(--needs-bg); color:var(--needs-txt); border:1px solid var(--needs-bd); }
.comment-status-tag.rejected { background:var(--rejected-bg); color:var(--rejected-txt); border:1px solid var(--rejected-bd); }
.comment-body { font-size:17px; font-weight:300; color:var(--text2); line-height:1.75; }
.no-comments { font-size:16px; color:var(--dim); font-style:italic; padding:16px 0; }
.sync-note { font-size:16px; color:var(--muted); display:flex; align-items:center; gap:6px; }
.post-nav-outer { max-width:740px; margin:0 auto; padding:36px 40px 40px; display:flex; justify-content:space-between; align-items:flex-start; gap:14px; }
@media(max-width:600px) {
  .phi,.pbw,.discussion-outer,.post-nav-outer { padding-left:16px; padding-right:16px; }
  .post-title { font-size:24px; }
  .post-subtitle { font-size:18px; }
  .post-body h2 { font-size:20px; }
  .comment-form-row { flex-direction:column; }
  .post-nav-outer { padding-top:24px; flex-direction:column; }
}

/* ── EDITOR ─────────────────────────────────────────────────────── */
.editor-outer { max-width:740px; margin:0 auto; padding:0 40px 0; }
.editor-bar { display:flex; align-items:center; justify-content:space-between; padding:14px 0; border-bottom:1px solid var(--border); margin-bottom:0; flex-wrap:wrap; gap:10px; }
.editor-bar-left { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
.editor-label { font-size:16px; font-weight:600; letter-spacing:.35em; color:var(--gold); text-transform:uppercase; }
.editor-mode-badge { font-size:16px; font-weight:500; letter-spacing:.2em; text-transform:uppercase; color:var(--muted); padding:3px 10px; border:1px solid var(--border); }
.editor-mode-badge.editing { color:var(--needs-txt); border-color:var(--needs-bd); background:var(--needs-bg); }
.editor-btn { font-family:'Montserrat',sans-serif; font-size:16px; font-weight:600; letter-spacing:.2em; text-transform:uppercase; padding:8px 18px; border:1px solid var(--border); background:transparent; color:var(--muted); cursor:pointer; transition:all .18s; white-space:nowrap; }
.editor-btn:hover { border-color:var(--gold); color:var(--gold); }
.editor-btn.primary { background:var(--gold); color:var(--darker); border-color:var(--gold); }
.editor-btn.primary:hover { opacity:.85; }
.editor-btn.danger { border-color:var(--rejected-bd); color:var(--rejected-txt); }
.editor-btn.danger:hover { background:var(--rejected-bg); }

.editor-toolbar { display:none; align-items:center; gap:4px; padding:10px 0; border-bottom:1px solid var(--border); flex-wrap:wrap; }
.editor-toolbar.visible { display:flex; }
.tb-btn { font-family:'Montserrat',sans-serif; font-size:16px; font-weight:600; padding:5px 10px; border:1px solid var(--border); background:var(--panel); color:var(--text2); cursor:pointer; transition:all .15s; min-width:32px; text-align:center; }
.tb-btn:hover { border-color:var(--gold); color:var(--gold); }
.tb-btn.active { background:var(--gold); color:var(--darker); border-color:var(--gold); }
.tb-sep { width:1px; height:24px; background:var(--border); margin:0 4px; }
.tb-label { font-size:16px; font-weight:500; letter-spacing:.2em; color:var(--dim); text-transform:uppercase; padding:0 4px; }

.editor-content { outline:none; min-height:200px; }
.editor-content.editable { background:var(--darker); border:1px solid var(--needs-bd); padding:24px 28px; margin:0; cursor:text; }
.editor-content.editable:focus { border-color:var(--gold); }
.editor-content.editable h2 { border-bottom:1px dashed var(--border); }

/* ── VERSION HISTORY ─────────────────────────────────────────────── */
.vh-outer { max-width:740px; margin:0 auto; padding:0 40px 0; }
.vh-bar { display:flex; align-items:center; justify-content:space-between; padding:14px 0; border-bottom:1px solid var(--border); cursor:pointer; user-select:none; }
.vh-bar:hover .vh-title { color:var(--text); }
.vh-title { font-size:16px; font-weight:600; letter-spacing:.35em; color:var(--muted); text-transform:uppercase; transition:color .18s; }
.vh-toggle { font-size:16px; color:var(--dim); transition:transform .2s; }
.vh-toggle.open { transform:rotate(180deg); }
.vh-list { display:none; flex-direction:column; gap:0; margin-bottom:0; }
.vh-list.open { display:flex; }
.vh-entry { display:flex; align-items:flex-start; gap:14px; padding:14px 0; border-bottom:1px solid var(--border2); cursor:pointer; transition:background .15s; }
.vh-entry:hover { background:var(--panel); margin:0 -16px; padding:14px 16px; }
.vh-entry-meta { flex:1; min-width:0; }
.vh-entry-time { font-size:16px; font-weight:500; color:var(--text2); display:block; margin-bottom:3px; }
.vh-entry-author { font-size:16px; color:var(--muted); font-weight:300; }
.vh-entry-preview { font-size:16px; color:var(--dim); font-weight:300; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:4px; }
.vh-restore-btn { font-family:'Montserrat',sans-serif; font-size:16px; font-weight:600; letter-spacing:.2em; text-transform:uppercase; padding:6px 14px; border:1px solid var(--border); background:transparent; color:var(--muted); cursor:pointer; flex-shrink:0; transition:all .18s; white-space:nowrap; }
.vh-restore-btn:hover { border-color:var(--gold); color:var(--gold); }
.vh-current-badge { font-size:16px; font-weight:600; letter-spacing:.2em; text-transform:uppercase; padding:6px 14px; color:var(--gold); border:1px solid var(--gold); flex-shrink:0; }
.vh-empty { font-size:16px; color:var(--dim); font-style:italic; padding:16px 0; }
.vh-diff { display:none; font-size:16px; color:var(--muted); font-weight:300; font-style:italic; margin-top:2px; }

/* ── RESTORE MODAL ───────────────────────────────────────────────── */
.restore-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.75); z-index:10000; align-items:center; justify-content:center; padding:20px; }
.restore-modal.open { display:flex; }
.restore-box { background:var(--dark); border:1px solid var(--border); max-width:680px; width:100%; max-height:80vh; display:flex; flex-direction:column; }
.restore-header { display:flex; align-items:center; justify-content:space-between; padding:18px 22px; border-bottom:1px solid var(--border); }
.restore-title { font-size:16px; font-weight:600; letter-spacing:.3em; text-transform:uppercase; color:var(--gold); }
.restore-close { font-size:20px; background:none; border:none; color:var(--muted); cursor:pointer; padding:4px 8px; }
.restore-close:hover { color:var(--text); }
.restore-preview { padding:20px 22px; overflow-y:auto; flex:1; }
.restore-preview h2 { font-size:18px; color:var(--text); margin:20px 0 8px; }
.restore-preview p { font-size:16px; color:var(--text2); line-height:1.8; margin-bottom:12px; }
.restore-actions { display:flex; gap:10px; padding:16px 22px; border-top:1px solid var(--border); justify-content:flex-end; }

@media(max-width:600px) {
  .editor-outer,.vh-outer { padding-left:16px; padding-right:16px; }
  .editor-bar { flex-direction:column; align-items:flex-start; }
  .editor-toolbar { gap:2px; }
  .tb-btn { padding:5px 8px; font-size:16px; }
}

</style>
</head>
<body>

<nav class="site-nav">
  <a href="index.html" class="nav-brand">
    <div class="nav-monogram">MDM</div>
    <span class="nav-title">Blog Review</span>
  </a>
  <div class="nav-right">
    <span class="live-dot" id="live-indicator">…</span>
    <a href="index.html" class="nav-back">← All Posts</a>
    <div class="nav-progress">
      <span class="nav-pill approved" id="pill-approved">0 ✓</span>
      <span class="nav-pill needs"    id="pill-needs">0 ⚠</span>
      <span class="nav-pill rejected" id="pill-rejected">0 ✕</span>
    </div>
  </div>
</nav>

<div class="post-header">
  <div class="phi">
    <div class="post-meta-row">
      <span class="post-num-badge">Post 08 of 25</span>
      <span class="post-date-str">Tuesday, May 19, 2026</span>
      <span class="post-cat">Trust Building</span>
    </div>
    <h1 class="post-title">Our Most Common Client Regrets</h1>
    <p class="post-subtitle">And How We Help Avoid Them</p>
    <div style="display:flex;align-items:center;gap:12px;margin-top:4px;">
      <span class="status-badge pending" id="status-badge"><span class="badge-text">Pending Review</span></span>
    </div>
    <div class="seo-box">
      <span class="seo-lbl">SEO Meta Description</span>
      <p>Even the best custom furniture projects can leave clients wishing they'd done something differently. MDM Design Studio shares the most common regrets — and how our process helps clients dodge them.</p>
    </div>
  </div>
</div>
<div class="gold-rule"></div>

<div class="pbw">
  <div class="post-body" id="post-body-content">
    <p>After years of designing and building custom furniture and cabinetry, we've accumulated a lot of wisdom — including the wisdom that comes from watching clients wish they'd done something differently. These regrets aren't failures of the pieces themselves. They're decisions that seemed reasonable at the time and only revealed their limitations in daily use.</p>
<p>The good news: every regret on this list is avoidable. Here's what we hear most often, and how our design process is specifically built to prevent each one.</p>

<h2>"I wish I had more drawers."</h2>
<p>This is the single most common piece of feedback we hear from cabinetry clients after they've lived with a kitchen or bathroom for a year. People consistently underestimate how much of their storage is better served by drawers than by shelves behind doors. A deep drawer that lets you see everything at once, pull it forward, and put it back is dramatically more functional than a lower cabinet with a door and a shelf — where everything in the back gets lost and forgotten.</p>
<p><strong>How we avoid it:</strong> We ask specifically about what's going in each cabinet during the design phase and push clients to think through their actual use patterns. We'll often recommend more drawers than clients initially request, and we explain why.</p>

<h2>"I should have gone taller / wider / deeper."</h2>
<p>Scale regret is common, especially in built-ins and storage pieces. A bookcase that seemed appropriately sized on a drawing can read as too modest once it's in the room, particularly when the ceiling height invited something more dramatic. Drawers that seemed deep enough turn out to be just slightly too shallow for the items going in them.</p>
<p><strong>How we avoid it:</strong> We use renderings and mockups to help clients visualize scale before anything is built. We also ask pointed questions about the specific items going in each drawer and shelf to verify that the proposed dimensions will work.</p>

<h2>"I wish I'd added lighting."</h2>
<p>Integrated lighting — inside display cabinets, under wall cabinets in a kitchen, along the interior of a wardrobe — is dramatically easier to add during the build than as a retrofit. Running wire, installing recessed LED channels, and hiding junction boxes are all straightforward when the piece is being built. Adding them later involves opening casework, fishing wire, and often compromising the finish.</p>
<p><strong>How we avoid it:</strong> We raise the question of integrated lighting proactively in our design process. Even if a client says no initially, we can run wire conduit during the build so that the option remains open later.</p>

<h2>"I didn't think through the hardware carefully enough."</h2>
<p>Hardware chosen quickly at the end of the design process — whatever was available, whatever was in stock — often reads as an afterthought on an otherwise considered piece. The wrong finish, the wrong proportion, or the wrong style can undermine months of careful design decisions.</p>
<p><strong>How we avoid it:</strong> We treat hardware selection as a formal step in the design process, presenting options in context and in relation to the overall room palette. We order samples where the choice isn't obvious.</p>

<h2>"I wish I'd done the whole wall."</h2>
<p>A run of cabinetry or shelving that stops short of the full wall — leaving a few feet of blank space on either end — almost always reads as incomplete. Full-wall built-ins have a visual completeness and authority that partial runs don't achieve.</p>
<p><strong>How we avoid it:</strong> When a client proposes a run of built-ins that stops short of the full wall without a clear architectural reason, we note it and discuss the options. Sometimes budget is the real constraint, in which case we can design a solution that allows for future extension.</p>

<h2>"I was too conservative with the finish."</h2>
<p>Clients sometimes choose the safest finish option available — the most neutral stain, the most expected paint color — and later wish they'd committed to something more personal. Custom furniture is one of the few places where you truly control every variable, including the one most people leave to convention.</p>
<p><strong>How we avoid it:</strong> We actively encourage clients to consider the bolder version of their vision during the design conversation. We share examples of projects where clients made confident finish choices and loved the results. We want your piece to feel like <em>you</em>, not like a showroom.</p>

<p class="cta-text">We've built a process specifically designed to surface these decisions at the right moment, before they become regrets. <a href="https://mdmdesignstudio.com/get-a-quote/">Get a quote</a> and let's work through the details together — all of them.</p>
  </div>
</div>


<!-- ── EDITOR ──────────────────────────────────────────────────────── -->
<div class="editor-outer">
  <div class="editor-bar">
    <div class="editor-bar-left">
      <span class="editor-label">Edit Draft</span>
      <span class="editor-mode-badge" id="edit-mode-badge">Read Only</span>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button class="editor-btn" id="edit-toggle-btn" onclick="toggleEditor()">✎ Edit</button>
      <button class="editor-btn primary" id="edit-save-btn" style="display:none;" onclick="saveEdit(8)">↑ Save Version</button>
      <button class="editor-btn danger" id="edit-cancel-btn" style="display:none;" onclick="cancelEdit()">✕ Cancel</button>
    </div>
  </div>

  <div class="editor-toolbar" id="editor-toolbar">
    <span class="tb-label">Format</span>
    <button class="tb-btn" onclick="fmt('bold')" title="Bold"><b>B</b></button>
    <button class="tb-btn" onclick="fmt('italic')" title="Italic"><i>I</i></button>
    <div class="tb-sep"></div>
    <span class="tb-label">Block</span>
    <button class="tb-btn" onclick="fmtBlock('h2')" title="Heading 2">H2</button>
    <button class="tb-btn" onclick="fmtBlock('h3')" title="Heading 3">H3</button>
    <button class="tb-btn" onclick="fmtBlock('p')" title="Paragraph">¶</button>
    <div class="tb-sep"></div>
    <button class="tb-btn" onclick="fmt('insertUnorderedList')" title="List">☰</button>
    <button class="tb-btn" onclick="wrapLink()" title="Link">⎆</button>
    <div class="tb-sep"></div>
    <button class="tb-btn" onclick="fmt('undo')" title="Undo">↩</button>
    <button class="tb-btn" onclick="fmt('redo')" title="Redo">↪</button>
  </div>
</div>

<!-- ── VERSION HISTORY ──────────────────────────────────────────────── -->
<div class="vh-outer">
  <div class="vh-bar" onclick="toggleVH()">
    <span class="vh-title">Version History <span id="vh-count" style="color:var(--dim);font-weight:300;letter-spacing:.05em;text-transform:none;"></span></span>
    <span class="vh-toggle" id="vh-toggle">▾</span>
  </div>
  <div class="vh-list" id="vh-list">
    <p class="vh-empty" id="vh-empty">No saved versions yet. Edit and save a version to start your history.</p>
  </div>
</div>

<!-- ── RESTORE MODAL ─────────────────────────────────────────────────── -->
<div class="restore-modal" id="restore-modal">
  <div class="restore-box">
    <div class="restore-header">
      <span class="restore-title">Restore this version?</span>
      <button class="restore-close" onclick="closeRestoreModal()">✕</button>
    </div>
    <div class="restore-preview" id="restore-preview"></div>
    <div class="restore-actions">
      <button class="editor-btn" onclick="closeRestoreModal()">Cancel</button>
      <button class="editor-btn primary" onclick="confirmRestore()">Restore this Version</button>
    </div>
  </div>
</div>

<!-- DISCUSSION -->
<div class="discussion-outer">
  <div class="discussion-header">
    <div>
      <div class="discussion-title">Discussion</div>
      <div class="discussion-subtitle">Notes and feedback — visible to everyone</div>
    </div>
    <span class="sync-note" id="sync-note">
      <span class="live-dot" id="disc-live" style="display:inline-flex;margin:0;"></span>
      Live
    </span>
  </div>

  <div class="comment-form">
    <div class="comment-form-row">
      <input type="text" class="comment-name-input" id="commenter-name" placeholder="Your name" maxlength="60">
    </div>
    <textarea class="comment-textarea" id="comment-text" placeholder="Leave a note, question, or feedback on this post — everyone can see it…"></textarea>
    <br>
    <button class="comment-submit" onclick="submitComment(8)">Post Note</button>
  </div>

  <div class="comments-list" id="comments-list">
    <p class="no-comments" id="no-comments-msg">No notes yet. Be the first to leave one.</p>
  </div>
</div>

<div class="post-nav-outer">
  <a class="post-nav-btn left" href="post-07.html"><span class="nav-arrow">‹</span><div><span class="nav-meta">Previous</span><span class="nav-name">The Real Cost of Custom Furniture</span></div></a>
  <div style="padding-top:16px;font-size:16px;font-weight:500;letter-spacing:.3em;color:var(--muted);text-transform:uppercase;">Post 8 of 25</div>
  <a class="post-nav-btn right" href="post-09.html"><div><span class="nav-meta">Next</span><span class="nav-name">When a Project Goes Sideways</span></div><span class="nav-arrow">›</span></a>
</div>

<!-- FLOATING REVIEW BAR -->
<div class="fab">
  <div class="fab-label">Your Review</div>
  <div class="fab-comment-box" id="fab-comment-box">
    <textarea class="fab-textarea" id="fab-textarea" placeholder="Leave a note visible to everyone…" rows="3"></textarea>
    <button class="fab-save-comment" onclick="fabSaveNote(8)">Post Note</button>
  </div>
  <div class="fab-buttons">
    <button class="fab-comment-toggle" onclick="toggleCommentBox()">+ Note</button>
    <button class="fab-btn needs"   data-action="needs"    onclick="fabAction(8,'needs')">⚠ Changes</button>
    <button class="fab-btn reject"  data-action="rejected" onclick="fabAction(8,'rejected')">✕ Reject</button>
    <button class="fab-btn approve" data-action="approved" onclick="fabAction(8,'approved')">✓ Approve</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script src="app.js"></script>
<script>
const POST_ID = 8;
const liveEl = document.getElementById('live-indicator');

window.addEventListener('DOMContentLoaded', () => {
  if (typeof emailjs !== 'undefined' && CONFIG.emailjsPublicKey !== 'YOUR_EMAILJS_PUBLIC_KEY') {
    emailjs.init(CONFIG.emailjsPublicKey);
  }
  initFirebase();
  initPostPage(POST_ID);
  loadComments(POST_ID);

  if (IS_CONFIGURED) {
    const connRef = firebase.database().ref('.info/connected');
    connRef.on('value', snap => {
      const c = snap.val();
      liveEl.textContent = c ? 'Live' : 'Offline';
      liveEl.className = 'live-dot ' + (c ? 'connected' : 'offline');
      const dl = document.getElementById('disc-live');
      if (dl) dl.className = 'live-dot ' + (c ? 'connected' : 'offline');
    });
  } else {
    liveEl.textContent = 'Local';
    liveEl.className = 'live-dot offline';
  }
});

// ── Comments ──────────────────────────────────────────────────────────────────

function loadComments(postId) {
  if (!IS_CONFIGURED || !_dbRef) { renderComments([]); return; }
  const commentsRef = firebase.database().ref(CONFIG.dbPath + '-comments/' + postId);
  commentsRef.on('value', snap => {
    const data = snap.val() || {};
    const list = Object.values(data).sort((a,b) => new Date(a.ts) - new Date(b.ts));
    renderComments(list);
  });
}

function renderComments(comments) {
  const el = document.getElementById('comments-list');
  const noMsg = document.getElementById('no-comments-msg');
  if (!comments.length) {
    if (noMsg) noMsg.style.display = '';
    // Clear any existing cards
    el.querySelectorAll('.comment-item').forEach(c => c.remove());
    return;
  }
  if (noMsg) noMsg.style.display = 'none';
  el.querySelectorAll('.comment-item').forEach(c => c.remove());
  comments.forEach(c => {
    const div = document.createElement('div');
    div.className = 'comment-item' + (c.status && c.status !== 'pending' ? ' highlight' : '');
    const statusTag = c.status && c.status !== 'pending'
      ? `<span class="comment-status-tag ${c.status}">${{approved:'✓ Approved',needs:'⚠ Changes',rejected:'✕ Rejected'}[c.status] || c.status}</span>`
      : '';
    const timeStr = new Date(c.ts).toLocaleString('en-US', {month:'short',day:'numeric',hour:'numeric',minute:'2-digit'});
    div.innerHTML = `
      <div class="comment-meta">
        <span class="comment-author">${c.author || 'Anonymous'}</span>
        <span class="comment-time">${timeStr}</span>
        ${statusTag}
      </div>
      <div class="comment-body">${c.text}</div>
    `;
    el.appendChild(div);
  });
}

async function submitComment(postId) {
  const nameEl = document.getElementById('commenter-name');
  const textEl = document.getElementById('comment-text');
  const name = (nameEl.value || '').trim() || 'Anonymous';
  const text = (textEl.value || '').trim();
  if (!text) return;

  const record = {
    author: name,
    text: text,
    status: null,
    ts: new Date().toISOString()
  };

  if (IS_CONFIGURED && _dbRef) {
    const commentsRef = firebase.database().ref(CONFIG.dbPath + '-comments/' + postId);
    await commentsRef.push(record);
  } else {
    // Local fallback — append to rendered list
    const list = [];
    list.push(record);
    renderComments(list);
  }

  textEl.value = '';
  showToast('comment');
}

// Override fabSaveNote to also post as comment with status
async function fabSaveNote(postId) {
  const ta = document.getElementById('fab-textarea');
  const nameEl = document.getElementById('commenter-name');
  const text = ta ? ta.value.trim() : '';
  if (!text) { toggleCommentBox(); return; }

  const d = getPostData(postId);
  const name = (nameEl && nameEl.value.trim()) || 'MDM Team';
  await setPostData(postId, d.status || 'pending', text);

  // Also post as public comment
  const record = {
    author: name,
    text: text,
    status: d.status !== 'pending' ? d.status : null,
    ts: new Date().toISOString()
  };
  if (IS_CONFIGURED && _dbRef) {
    const commentsRef = firebase.database().ref(CONFIG.dbPath + '-comments/' + postId);
    await commentsRef.push(record);
  }

  if (ta) ta.value = '';
  toggleCommentBox();
  showToast('comment');
}

// Also post a comment when status changes via fab buttons
const _origFabAction = window.fabAction;
window.fabAction = async function(postId, action) {
  await _origFabAction(postId, action);
  // Post a status-change comment automatically
  const d = getPostData(postId);
  const nameEl = document.getElementById('commenter-name');
  const name = (nameEl && nameEl.value.trim()) || 'Reviewer';
  const statusLabels = {approved:'✓ Approved this post',needs:'⚠ Flagged for changes',rejected:'✕ Rejected this post',pending:'Reset to pending'};
  const record = {
    author: name,
    text: statusLabels[d.status] || d.status,
    status: d.status !== 'pending' ? d.status : null,
    ts: new Date().toISOString()
  };
  if (IS_CONFIGURED && _dbRef) {
    const commentsRef = firebase.database().ref(CONFIG.dbPath + '-comments/' + postId);
    await commentsRef.push(record);
  }
};

// ── EDITOR ───────────────────────────────────────────────────────────────────

let _editingMode = false;
let _originalHTML = '';
let _pendingRestore = null;

function toggleEditor() {
  if (_editingMode) { cancelEdit(); return; }
  _editingMode = true;
  _originalHTML = document.getElementById('post-body-content').innerHTML;

  const body = document.getElementById('post-body-content');
  body.classList.add('editable');
  body.contentEditable = 'true';
  body.focus();

  document.getElementById('edit-mode-badge').textContent = 'Editing';
  document.getElementById('edit-mode-badge').classList.add('editing');
  document.getElementById('editor-toolbar').classList.add('visible');
  document.getElementById('edit-toggle-btn').style.display = 'none';
  document.getElementById('edit-save-btn').style.display = '';
  document.getElementById('edit-cancel-btn').style.display = '';
}

function cancelEdit() {
  _editingMode = false;
  const body = document.getElementById('post-body-content');
  body.innerHTML = _originalHTML;
  body.classList.remove('editable');
  body.contentEditable = 'false';

  document.getElementById('edit-mode-badge').textContent = 'Read Only';
  document.getElementById('edit-mode-badge').classList.remove('editing');
  document.getElementById('editor-toolbar').classList.remove('visible');
  document.getElementById('edit-toggle-btn').style.display = '';
  document.getElementById('edit-save-btn').style.display = 'none';
  document.getElementById('edit-cancel-btn').style.display = 'none';
}

async function saveEdit(postId) {
  const body = document.getElementById('post-body-content');
  const html = body.innerHTML;
  const nameEl = document.getElementById('commenter-name');
  const author = (nameEl && nameEl.value.trim()) || 'Editor';

  const version = {
    html: html,
    author: author,
    ts: new Date().toISOString(),
    preview: body.innerText.replace(/\s+/g, ' ').trim().slice(0, 120) + '…'
  };

  if (IS_CONFIGURED && _dbRef) {
    const vhRef = firebase.database().ref(CONFIG.dbPath + '-versions/' + postId);
    await vhRef.push(version);
    // Also update live current content
    await firebase.database().ref(CONFIG.dbPath + '-content/' + postId).set({ html, ts: version.ts, author });
  } else {
    // localStorage fallback
    const key = 'mdm_versions_' + postId;
    const existing = JSON.parse(localStorage.getItem(key) || '[]');
    existing.push(version);
    localStorage.setItem(key, JSON.stringify(existing));
    renderVersionHistory(existing, postId);
  }

  _originalHTML = html; // update baseline so cancel doesn't revert
  cancelEdit();
  showToast('comment');

  // Post as discussion note
  const record = { author, text: '✎ Draft edited and saved as new version', status: null, ts: version.ts };
  if (IS_CONFIGURED && _dbRef) {
    await firebase.database().ref(CONFIG.dbPath + '-comments/' + postId).push(record);
  }
}

function fmt(cmd) {
  document.execCommand(cmd, false, null);
  document.getElementById('post-body-content').focus();
}

function fmtBlock(tag) {
  document.execCommand('formatBlock', false, tag);
  document.getElementById('post-body-content').focus();
}

function wrapLink() {
  const url = prompt('Enter URL:', 'https://');
  if (url) document.execCommand('createLink', false, url);
  document.getElementById('post-body-content').focus();
}

// ── VERSION HISTORY ───────────────────────────────────────────────────────────

function loadVersionHistory(postId) {
  if (!IS_CONFIGURED || !_dbRef) {
    const key = 'mdm_versions_' + postId;
    const existing = JSON.parse(localStorage.getItem(key) || '[]');
    renderVersionHistory(existing, postId);
    return;
  }
  const vhRef = firebase.database().ref(CONFIG.dbPath + '-versions/' + postId);
  vhRef.on('value', snap => {
    const data = snap.val() || {};
    const list = Object.entries(data)
      .map(([k, v]) => ({ ...v, _key: k }))
      .sort((a, b) => new Date(b.ts) - new Date(a.ts));
    renderVersionHistory(list, postId);
  });

  // Also listen for live content updates from other editors
  const contentRef = firebase.database().ref(CONFIG.dbPath + '-content/' + postId);
  contentRef.on('value', snap => {
    const data = snap.val();
    if (data && !_editingMode) {
      document.getElementById('post-body-content').innerHTML = data.html;
    }
  });
}

function renderVersionHistory(versions, postId) {
  const list = document.getElementById('vh-list');
  const empty = document.getElementById('vh-empty');
  const count = document.getElementById('vh-count');

  list.querySelectorAll('.vh-entry').forEach(e => e.remove());

  if (!versions.length) {
    if (empty) empty.style.display = '';
    count.textContent = '';
    return;
  }
  if (empty) empty.style.display = 'none';
  count.textContent = '(' + versions.length + ')';

  versions.forEach((v, i) => {
    const div = document.createElement('div');
    div.className = 'vh-entry';
    const timeStr = new Date(v.ts).toLocaleString('en-US', {
      month: 'short', day: 'numeric', year: 'numeric',
      hour: 'numeric', minute: '2-digit'
    });
    const isCurrent = i === 0;
    div.innerHTML = `
      <div class="vh-entry-meta">
        <span class="vh-entry-time">${timeStr}</span>
        <span class="vh-entry-author">Saved by ${v.author || 'Editor'}</span>
        <div class="vh-entry-preview">${v.preview || ''}</div>
      </div>
      ${isCurrent
        ? '<span class="vh-current-badge">Current</span>'
        : `<button class="vh-restore-btn" onclick="openRestoreModal(${JSON.stringify(v).replace(/"/g, '&quot;')}, ${postId})">Restore</button>`
      }
    `;
    list.appendChild(div);
  });
}

function toggleVH() {
  const list = document.getElementById('vh-list');
  const toggle = document.getElementById('vh-toggle');
  const isOpen = list.classList.contains('open');
  list.classList.toggle('open', !isOpen);
  toggle.classList.toggle('open', !isOpen);
}

function openRestoreModal(version, postId) {
  _pendingRestore = { version, postId };
  const preview = document.getElementById('restore-preview');
  preview.innerHTML = version.html;
  document.getElementById('restore-modal').classList.add('open');
}

function closeRestoreModal() {
  _pendingRestore = null;
  document.getElementById('restore-modal').classList.remove('open');
}

async function confirmRestore() {
  if (!_pendingRestore) return;
  const { version, postId } = _pendingRestore;
  const body = document.getElementById('post-body-content');
  body.innerHTML = version.html;

  // Save restored content as a new version
  const nameEl = document.getElementById('commenter-name');
  const author = (nameEl && nameEl.value.trim()) || 'Editor';
  const newVersion = {
    html: version.html,
    author: author + ' (restored)',
    ts: new Date().toISOString(),
    preview: body.innerText.replace(/\s+/g, ' ').trim().slice(0, 120) + '…'
  };

  if (IS_CONFIGURED && _dbRef) {
    await firebase.database().ref(CONFIG.dbPath + '-versions/' + postId).push(newVersion);
    await firebase.database().ref(CONFIG.dbPath + '-content/' + postId).set({ html: version.html, ts: newVersion.ts, author: newVersion.author });
  } else {
    const key = 'mdm_versions_' + postId;
    const existing = JSON.parse(localStorage.getItem(key) || '[]');
    existing.unshift(newVersion);
    localStorage.setItem(key, JSON.stringify(existing));
    renderVersionHistory(existing, postId);
  }

  closeRestoreModal();
  showToast('comment');
  _originalHTML = version.html;
}


  // Init editor
  loadVersionHistory(POST_ID);
</script>
</body>
</html>